<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Letsencrypt on 翱翔在空中</title><link>https://anemology.cc/tags/letsencrypt/</link><description>Recent content in Letsencrypt on 翱翔在空中</description><generator>Hugo</generator><language>zh-TW</language><lastBuildDate>Sat, 22 Feb 2025 19:37:45 +0800</lastBuildDate><atom:link href="https://anemology.cc/tags/letsencrypt/index.xml" rel="self" type="application/rss+xml"/><item><title>ACME Certificate Profile</title><link>https://anemology.cc/post/acme-certificate-profile/</link><pubDate>Sat, 22 Feb 2025 19:37:45 +0800</pubDate><guid>https://anemology.cc/post/acme-certificate-profile/</guid><description>&lt;p>最近要將公司服務更新憑證的方式改用 ACME client，在測試的時候發現 pebble 簽發的憑證有效期限從原本的三個月變成了五天，這篇文章會稍微記錄一下原因。&lt;/p>
&lt;p>ACME (Automatic Certificate Management Environment) &lt;a href="https://datatracker.ietf.org/doc/rfc8555/">RFC 8555&lt;/a> 是為了自動化更新憑證而誕生的一個協定。&lt;/p>
&lt;p>&lt;a href="https://github.com/letsencrypt/pebble">pebble&lt;/a> 是 &lt;a href="https://letsencrypt.org/">Let&amp;rsquo;s Encrypt&lt;/a> 提供的 ACME 測試 server，可以簡單地在 CI 環境內或者 local 進行測試，雖然 Let&amp;rsquo;s Encrypt 也有提供 &lt;a href="https://letsencrypt.org/docs/staging-environment/">staging&lt;/a> 環境，但是有一個 self-hosted 的測試環境再加上可以自訂設定還是比較方便。而這篇文章會用 ACME client &lt;a href="https://github.com/certbot/certbot">certbot&lt;/a> 搭配 pebble 測試。&lt;/p>
&lt;p>首先用 docker 起一個 local 的 pebble server，使用 certbot 產生 example.com 憑證，Not Before 會是當下時間，而 Not After 則是三個月後：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ openssl x509 -noout -text -in /etc/live/example.com/cert.pem | grep &lt;span style="color:#e6db74">&amp;#34;Validity&amp;#34;&lt;/span> -A2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Validity
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Not Before: Feb &lt;span style="color:#ae81ff">22&lt;/span> 08:35:30 &lt;span style="color:#ae81ff">2025&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Not After : May &lt;span style="color:#ae81ff">23&lt;/span> 08:35:29 &lt;span style="color:#ae81ff">2025&lt;/span> GMT
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>再用一次 certbot 加上 &lt;code>--force-renewal&lt;/code> 強制 renew 後，發現期限竟然變成了六天後：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ openssl x509 -noout -text -in /etc/live/example.com/cert.pem | grep &lt;span style="color:#e6db74">&amp;#34;Validity&amp;#34;&lt;/span> -A2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Validity
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Not Before: Feb &lt;span style="color:#ae81ff">22&lt;/span> 09:30:29 &lt;span style="color:#ae81ff">2025&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Not After : Feb &lt;span style="color:#ae81ff">28&lt;/span> 09:30:28 &lt;span style="color:#ae81ff">2025&lt;/span> GMT
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>所以就去查 pebble source code 看有沒有什麼關於有效期限的設定，最後在 &lt;a href="https://github.com/letsencrypt/pebble/blob/9a99831fce2f8f72cb1124b051da99dbe133fde9/test/config/pebble-config.json#L23">test/config/pebble-config.json&lt;/a> 內發現 &lt;code>&amp;quot;validityPeriod&amp;quot;: 518400&lt;/code>，剛好 518400 秒 == 6 天。&lt;/p>
&lt;p>而 profiles 內有兩個設定，&lt;code>default&lt;/code> 和 &lt;code>shortlived&lt;/code>， pebble 是怎麼選擇的呢？如果 ACME client 在發出 order 時沒有指定 profile，pebble &lt;a href="https://github.com/letsencrypt/pebble/blob/9a99831fce2f8f72cb1124b051da99dbe133fde9/wfe/wfe.go#L1731">wfe/wfe.go&lt;/a> 就會隨機選&amp;hellip;&lt;/p>
&lt;hr>
&lt;p>&lt;a href="https://datatracker.ietf.org/doc/draft-aaron-acme-profiles/">Profile selection&lt;/a> 目前還只是 draft，而 Let&amp;rsquo;s Encrypt 在&lt;a href="https://letsencrypt.org/2025/01/09/acme-profiles/">公告&lt;/a>內指出會由 server 決定，不確定各 CA 的 ACME server 會怎麼實作&lt;/p>
&lt;blockquote>
&lt;p>If the new-order request does not specify a profile, then the server will select one for it.&lt;/p>&lt;/blockquote>
&lt;p>而 certbot 今天剛好在相關的 issue &lt;a href="https://github.com/certbot/certbot/issues/9261#issuecomment-2675915347">#9261&lt;/a> 內有更新，預計今年會實作 ACME profiles。&lt;/p>
&lt;p>如果要固定 profile，暫時的解決方式是修改 pebble-config.json 只留下想要的，或是改用有支援的 client &lt;a href="https://github.com/go-acme/lego/releases/tag/v4.22.0">lego&lt;/a>。&lt;/p>
&lt;p>最後，有興趣的也可以看看 Let’s Encrypt 最新的公告 &lt;a href="https://letsencrypt.org/2025/02/20/first-short-lived-cert-issued/">We Issued Our First Six Day Cert - Let&amp;rsquo;s Encrypt&lt;/a>&lt;/p></description></item></channel></rss>