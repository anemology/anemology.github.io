<!doctype html><html lang=zh-tw><head><meta charset=utf-8><title>尋找 Plurk 噗文連結</title><meta name=description content><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://anemology.cc/index.xml title=翱翔在空中><meta name=twitter:card content="summary"><meta name=twitter:title content="尋找 Plurk 噗文連結"><meta name=twitter:description content="最近在改寫自己的 噗浪下載程式，發現噗文連結並沒有在 API response 內，因此尋找了一下，此篇文章則是記錄過程及思路。"><link rel=stylesheet href=https://anemology.cc/fontawesome/css/all.min.css><link crossorigin=anonymous href=/css/styles.min.css integrity rel="preload stylesheet" as=style><link rel=stylesheet href=https://anemology.cc/css/custom.css><link id=dark-mode-theme crossorigin=anonymous href=/css/dark.min.css integrity rel="preload stylesheet" as=style><script>var darkTheme=document.getElementById("dark-mode-theme"),storedTheme=localStorage.getItem("dark-mode-storage");storedTheme==="dark"?darkTheme.disabled=!1:storedTheme==="light"&&(darkTheme.disabled=!0)</script><script defer crossorigin=anonymous src=/js/theme.js integrity></script>
<script defer crossorigin=anonymous src=/js/instantpage.min.js integrity></script><meta name=generator content="Hugo 0.98.0"></head><body><header><nav class=navbar><div class=nav><ul class=nav-links><li><a href=/tags id=Tags><em class="fas fa-tag fa-lg"></em></a></li><li><a href=/search id=Search><em class="fas fa-search fa-lg"></em></a></li><li><a href=/archives id=Archives><em class="fas fa-archive fa-lg"></em></a></li></ul></div></nav><div class=intro-header><div class=container><div class=post-heading><h1>尋找 Plurk 噗文連結</h1><span class=meta-post><em class="fa fa-calendar-alt"></em>&nbsp;May 21, 2022</span></div></div></div></header><div class=container role=main><article class=article class=blog-post><p>最近在改寫自己的 <a href=https://github.com/anemology/plurkdl>噗浪下載程式</a>，發現噗文連結並沒有在 API response 內，因此尋找了一下，此篇文章則是記錄過程及思路。</p><p>每篇噗文右下角向下箭頭點開，有個開啟網址的連結，可以連到單篇噗文的網頁，網址後段是 <code>/p/xxxxxx</code>。後面的 <code>x</code> 包含英數，看起來像是亂數或是雜湊值產生，初步猜想是後端生成。</p><h2 id=尋找流程>尋找流程</h2><ol><li><p>查看 <code>/TimeLine/getPlurks</code> (取得噗文列表)、<code>/Responses/get</code> (取得單篇噗文回應)，這兩支 API 回傳資料都沒有找到對應字串。</p></li><li><p>使用瀏覽器 DevTools 的網路，看原始 html 內容，也不是後端 render 回傳，因此判斷是 JavaScript 產生。</p></li><li><p>以下截圖皆為 Firefox，使用檢測元素指到 <strong>開啟網址</strong> 元素，class 是 <code>pif-outlink</code>，JavaScript 通常會使用 css selector + class name 來進行操作。</p><p><img src=/img/find-plurk-permalink-1.png alt=find-plurk-permalink-1></p></li><li><p>切到 DevTools 除錯器，按 Ctrl+Shift+F 搜尋現在網頁所載入的所有資源，在一個 minify 過的 js 內找到這個 class。點左下的大括號來將 js 排版一下，雖然變數命名沒有改變，但至少可以看到比較清楚的排版。</p><p>產生連結的方式是 <code>o.toString(36)</code>，再往上找到 <code>o</code> 的定義，<code>o = r(s)</code>。</p><p><img src=/img/find-plurk-permalink-2.png alt=find-plurk-permalink-2></p></li><li><p>繼續往上，<code>r</code> 的定義是一個 function，<code>.data()</code> 是 jQuery 來取得某元素 data-attribue 的方法，因此可以判斷 <code>e(s)</code> 是某一個元素。</p><p>最後可以得知，一開始的 <code>o</code> 會回傳某一個元素的 <code>data-pid</code> attribute。</p><p><img src=/img/find-plurk-permalink-3.png alt=find-plurk-permalink-3></p></li><li><p>回到 DevTools 檢測器，搜尋 <code>data-pid</code>，發現每一個噗文最外層 div 有這個 attribute，而這個 pid 其實就是 API 回傳的 <code>plurk_id</code>。</p><p><img src=/img/find-plurk-permalink-4.png alt=find-plurk-permalink-4></p></li><li><p>一開始產生連結的方法是 <code>o.toString(36)</code>，查了 <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/toString>MDN 的定義</a>，是產生 n 進位的字串，把值丟進去跑，就可以產生對應的字串了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>$</span> Number(<span style=color:#ae81ff>1500449470</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#ae81ff>36</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;otbu7y&#34;</span>
</span></span></code></pre></div></li></ol><p>最後要轉成 Python code，Python 有內建 <code>hex()</code> 轉換 16 進位文字，但是沒有支援 36 進位，因此使用 mod 和整除的方式來 <a href=https://github.com/anemology/plurkdl/blob/master/plurkdl.py#L162>簡單實作</a> 一下，完成！</p><div class=blog-tags><a href=https://anemology.cc/tags/plurk/>plurk</a>&nbsp;
<a href=https://anemology.cc/tags/javascript/>javascript</a>&nbsp;</div><ul class=bottomnav><li class=next><a href=/post/hexo-and-next-update/>Hexo 及 NexT 主題升級紀錄<span>&nbsp;>></span></a></li></ul></article></div><footer><div class=social-icons></div><div class=container><p class="credits copyright"><a href=https://anemology.cc/about>anemology</a>
&nbsp;&copy;
2022
&nbsp;/&nbsp;
<a href=https://anemology.cc/>翱翔在空中</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>